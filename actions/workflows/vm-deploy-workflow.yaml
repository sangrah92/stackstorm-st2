version: 1.0
description: A workflow to crate resource group and deploy VM and get status of resource creation in azure portal.
input:
  - client_id
  - serect
  - tenant_id
  - subscription_number
  - resource_group
  - region
  - template_file

vars:
  - result: ''
  - error: ''

tasks:

  auth_credentials:
    action: dd_shieldx.authenticate 
    input: 
      client_id: <% ctx(client_id) %> 
      serect: <% ctx(serect) %> 
      tenant_id: <% ctx(tenant_id) %> 
      subscription_number: <% ctx(subscription_number) %> 
      resource_group: <% ctx(resource_group) %> 
      region: <% ctx(region) %> 
      template_file: <% ctx(template_file) %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        do:
          - resource_group_creation
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        do:
          - finish_error

  resource_group_creation:
    action: dd_shieldx.create_resource_group 
    input:
      credentials: <% task(auth_credentials).result.result.credentials %> 
      subscription_id: <% task(auth_credentials).result.result.subscription_id %>
      region: <% task(auth_credentials).result.result.location %>
      resource_group: <% task(auth_credentials).result.result.resource_group %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %> 
        do:
          - deploy_vm
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        do:
          - finish_error
  deploy_vm:
    action: dd_shieldx.vm_deploy
    input:
      existing_template_path: <% task(auth_credentials).result.result.template_file %>
      resource_group_client: <% task(resource_group_creation).result.result %>
      resource_group: <% task(auth_credentials).result.result.resource_group %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %> 
        do:
          - finish  
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        do:
          - finish_error
  finish:
    action: core.echo
    input:
      message: "Azure vm created successfully"    
  finish_error:
    action: core.echo
    input:
      message: "VM deploy occured an error"
output:
  - result: '{{ ctx(result)  }}'
  - error: '{{ ctx(error) }}'        
