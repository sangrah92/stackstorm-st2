version: 1.0
description: A workflow to crate resource group and deploy VM and get status of resource creation in azure portal.
input:
  - client_id
  - serect
  - tanent_id
  - subscription_number
  - resource_group
  - region
  - template_file

vars:
  - result: ''
  - error: ''

tasks:

  auth_credentials:
    action: dd_shieldx.authenticate 
    input: 
      client_id: <% ctx(client_id) %> 
      serect: <% ctx(serect) %> 
      tanent_id: <% ctx(tanent_id) %> 
      subscription_number: <% ctx(subscription_number) %> 
      resource_group: <% ctx(resource_group) %> 
      region: <% ctx(region) %> 
      template_file: <% ctx(template_file) %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        do:
          - resource_group_creation
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        do:
          - resource_group_creation
          
  resource_group_creation:
    action: dd_shieldx.create_resource_group 
    input:
      credentials: <% task(auth_credentials).result.result.credentials %> 
      subscription_id: <% task(auth_credentials).result.result.subscription_id %>
      region: <% task(auth_credentials).result.result.location %>
      resource_group: <% task(auth_credentials).result.result.resource_group %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %> 
        
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        
  
output:
  - result: '{{ ctx(result)  }}'
  - error: '{{ ctx(error) }}'        
